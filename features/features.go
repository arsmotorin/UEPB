package features

import (
	"fmt"
	"log"
	"strings"
	"time"

	"UEPB/interfaces"

	tb "gopkg.in/telebot.v4"
)

// FeatureHandler handles all user feature functionality
type FeatureHandler struct {
	bot         *tb.Bot
	state       interfaces.UserState
	quiz        interfaces.QuizInterface
	blacklist   interfaces.BlacklistInterface
	adminChatID int64
	violations  map[int64]int
	Btns        struct {
		Student, Guest, Ads tb.InlineButton
	}
	adminHandler interfaces.AdminHandlerInterface
}

// NewFeatureHandler creates a new feature handler
func NewFeatureHandler(bot *tb.Bot, state interfaces.UserState, quiz interfaces.QuizInterface, blacklist interfaces.BlacklistInterface, adminChatID int64, violations map[int64]int, adminHandler interfaces.AdminHandlerInterface, btns struct{ Student, Guest, Ads tb.InlineButton }) *FeatureHandler {
	return &FeatureHandler{
		bot:          bot,
		state:        state,
		quiz:         quiz,
		blacklist:    blacklist,
		adminChatID:  adminChatID,
		violations:   violations,
		Btns:         btns,
		adminHandler: adminHandler,
	}
}

// OnlyNewbies middleware to restrict handlers to newbies only
func (fh *FeatureHandler) OnlyNewbies(handler func(tb.Context) error) func(tb.Context) error {
	return func(c tb.Context) error {
		if c.Sender() == nil || !fh.state.IsNewbie(int(c.Sender().ID)) {
			if cb := c.Callback(); cb != nil {
				_ = fh.bot.Respond(cb, &tb.CallbackResponse{
					Text:      "–¢—ã –Ω–µ –º–æ–∂–µ—à—å –Ω–∞–∂–∏–º–∞—Ç—å –Ω–∞ —á—É–∂–∏–µ –∫–Ω–æ–ø–∫–∏",
					ShowAlert: false,
				})
			}
			return nil
		}
		return handler(c)
	}
}

// SendOrEdit sends a new message or edits an existing one
func (fh *FeatureHandler) SendOrEdit(chat *tb.Chat, msg *tb.Message, text string, rm *tb.ReplyMarkup) *tb.Message {
	var err error
	if msg == nil {
		msg, err = fh.bot.Send(chat, text, rm)
	} else {
		msg, err = fh.bot.Edit(msg, text, rm)
	}
	if err != nil {
		log.Println("Message error:", err)
		return nil
	}
	return msg
}

// SetUserRestriction sets user permissions in chat
func (fh *FeatureHandler) SetUserRestriction(chat *tb.Chat, user *tb.User, allowAll bool) {
	var rights tb.Rights
	if allowAll {
		rights = tb.Rights{
			CanSendMessages:   true,
			CanSendAudios:     true,
			CanSendDocuments:  true,
			CanSendPhotos:     true,
			CanSendVideos:     true,
			CanSendVideoNotes: true,
			CanSendVoiceNotes: true,
			CanSendPolls:      true,
		}
	} else {
		rights = tb.Rights{
			CanSendMessages: false,
		}
	}

	if err := fh.bot.Restrict(chat, &tb.ChatMember{
		User:   user,
		Rights: rights,
	}); err != nil {
		log.Println("Restrict error:", err)
	}
}

// GetNewUsers extracts new users from a join message
func GetNewUsers(msg *tb.Message) []*tb.User {
	if len(msg.UsersJoined) > 0 {
		users := make([]*tb.User, len(msg.UsersJoined))
		for i := range msg.UsersJoined {
			users[i] = &msg.UsersJoined[i]
		}
		return users
	}
	if msg.UserJoined != nil {
		return []*tb.User{msg.UserJoined}
	}
	return nil
}

// HandleUserJoined handles user joining the chat
func (fh *FeatureHandler) HandleUserJoined(c tb.Context) error {
	if c.Message() == nil || c.Chat() == nil {
		return nil
	}
	users := GetNewUsers(c.Message())
	keyboard := &tb.ReplyMarkup{
		InlineKeyboard: [][]tb.InlineButton{{fh.Btns.Student}, {fh.Btns.Guest}, {fh.Btns.Ads}},
	}

	for _, u := range users {
		fh.state.SetNewbie(int(u.ID))
		fh.SetUserRestriction(c.Chat(), u, false)

		text := "üëã –ü—Ä–∏–≤–µ—Ç!\n\n–í—ã–±–µ—Ä–∏, —á—Ç–æ —Ç–µ–±—è –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É—è –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ."
		if u.Username != "" {
			text = fmt.Sprintf("üëã –ü—Ä–∏–≤–µ—Ç, @%s!\n\n–í—ã–±–µ—Ä–∏, —á—Ç–æ —Ç–µ–±—è –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É—è –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ.", u.Username)
		}
		msg := fh.SendOrEdit(c.Chat(), nil, text, keyboard)
		fh.adminHandler.DeleteAfter(msg, 5*time.Minute)
		fh.state.InitUser(int(u.ID))

		// Log to admin chat
		logMsg := fmt.Sprintf("üë§ –ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –≤–æ—à—ë–ª –≤ —á–∞—Ç\n\n"+
			"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: %s\n"+
			"–ß–∞—Ç: %s (ID: %d)",
			fh.adminHandler.GetUserDisplayName(u),
			c.Chat().Title,
			c.Chat().ID)
		fh.adminHandler.LogToAdmin(logMsg)
	}
	return nil
}

// HandleUserLeft handles user leaving the chat
func (fh *FeatureHandler) HandleUserLeft(c tb.Context) error {
	if c.Message() == nil || c.Chat() == nil || c.Message().UserLeft == nil {
		return nil
	}

	user := c.Message().UserLeft
	fh.state.ClearNewbie(int(user.ID))

	// Reset violations
	fh.adminHandler.ClearViolations(user.ID)

	// Log to admin chat
	logMsg := fmt.Sprintf("üëã –£—á–∞—Å—Ç–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç\n\n"+
		"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: %s\n"+
		"–ß–∞—Ç: %s (ID: %d)",
		fh.adminHandler.GetUserDisplayName(user),
		c.Chat().Title,
		c.Chat().ID)
	fh.adminHandler.LogToAdmin(logMsg)

	return nil
}

// HandleStudent handles student button click
func (fh *FeatureHandler) HandleStudent(c tb.Context) error {
	fh.state.InitUser(int(c.Sender().ID))
	questions := fh.quiz.GetQuestions()
	if len(questions) > 0 {
		q := questions[0]
		_ = fh.SendOrEdit(c.Chat(), c.Message(), q.GetText(), &tb.ReplyMarkup{InlineKeyboard: [][]tb.InlineButton{q.GetButtons()}})
	}
	return nil
}

// HandleGuest handles guest button click
func (fh *FeatureHandler) HandleGuest(c tb.Context) error {
	fh.SetUserRestriction(c.Chat(), c.Sender(), true)
	fh.state.ClearNewbie(int(c.Sender().ID))
	msg := fh.SendOrEdit(c.Chat(), c.Message(), "‚úÖ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –≤ —á–∞—Ç. –ó–∞–¥–∞–π –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å.", nil)
	fh.adminHandler.DeleteAfter(msg, 5*time.Second)
	return nil
}

// HandleAds handles ads button click
func (fh *FeatureHandler) HandleAds(c tb.Context) error {
	msg := fh.SendOrEdit(c.Chat(), c.Message(), "üì¢ –ú—ã –æ—Ç–∫—Ä—ã—Ç—ã –∫ —Ä–µ–∫–ª–∞–º–µ.\n\n–ù–∞–ø–∏—à–∏ @chathlp –∏ –æ–ø–∏—à–∏, —á—Ç–æ —Ö–æ—á–µ—à—å –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å.", nil)
	fh.adminHandler.DeleteAfter(msg, 10*time.Second)

	// Log to admin chat
	logMsg := fmt.Sprintf("üì¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª —Ä–µ–∫–ª–∞–º—É\n\n"+
		"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: %s\n"+
		"–ß–∞—Ç: %s (ID: %d)",
		fh.adminHandler.GetUserDisplayName(c.Sender()),
		c.Chat().Title,
		c.Chat().ID)
	fh.adminHandler.LogToAdmin(logMsg)

	return nil
}

// HandlePing handles /ping command
func (fh *FeatureHandler) HandlePing(c tb.Context) error {
	start := time.Now()

	// Send the response and measure time
	msg, err := fh.bot.Send(c.Chat(), "üèì –ü–æ–Ω–≥!")
	if err != nil {
		log.Printf("[ERROR] Failed to send ping response: %v", err)
		return err
	}

	// Calculate response time
	responseTime := time.Since(start)
	responseMs := int(responseTime.Nanoseconds() / 1000000) // Convert to milliseconds

	// Edit the message with response time
	finalText := fmt.Sprintf("üèì –ü–æ–Ω–≥! (%d –º—Å)", responseMs)
	_, err = fh.bot.Edit(msg, finalText)
	if err != nil {
		log.Printf("[ERROR] Failed to edit ping message: %v", err)
	}

	return nil
}

// RegisterQuizHandlers registers all quiz button handlers
func (fh *FeatureHandler) RegisterQuizHandlers(bot *tb.Bot) {
	questions := fh.quiz.GetQuestions()
	for i, q := range questions {
		for _, btn := range q.GetButtons() {
			bot.Handle(&btn, fh.OnlyNewbies(fh.CreateQuizHandler(i, q, btn)))
		}
	}
}

// CreateQuizHandler creates a handler for the quiz button
func (fh *FeatureHandler) CreateQuizHandler(i int, q interfaces.QuestionInterface, btn tb.InlineButton) func(tb.Context) error {
	return func(c tb.Context) error {
		userID := int(c.Sender().ID)
		if btn.Unique == q.GetAnswer() {
			fh.state.IncCorrect(userID)
		}

		questions := fh.quiz.GetQuestions()
		if i+1 < len(questions) {
			next := questions[i+1]
			_ = fh.SendOrEdit(c.Chat(), c.Message(), next.GetText(), &tb.ReplyMarkup{InlineKeyboard: [][]tb.InlineButton{next.GetButtons()}})
			return nil
		}

		totalCorrect := fh.state.TotalCorrect(userID)
		totalQuestions := len(questions)
		if totalCorrect >= 2 {
			fh.SetUserRestriction(c.Chat(), c.Sender(), true)
			fh.state.ClearNewbie(userID)
			msg := fh.SendOrEdit(c.Chat(), c.Message(), "‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –≤ —á–∞—Ç.", nil)
			fh.adminHandler.DeleteAfter(msg, 3*time.Second)

			// Log successful verification to admin chat
			logMsg := fmt.Sprintf("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à—ë–ª –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é\n\n"+
				"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: %s\n"+
				"–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: %d/%d\n"+
				"–ß–∞—Ç: %s (ID: %d)",
				fh.adminHandler.GetUserDisplayName(c.Sender()),
				totalCorrect,
				totalQuestions,
				c.Chat().Title,
				c.Chat().ID)
			fh.adminHandler.LogToAdmin(logMsg)
		} else {
			msg := fh.SendOrEdit(c.Chat(), c.Message(), "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å—Ç—É–¥–µ–Ω—Ç–∞.", nil)
			fh.adminHandler.DeleteAfter(msg, 5*time.Second)

			// Log failed verification to admin chat
			logMsg := fmt.Sprintf("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–æ—à—ë–ª –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é\n\n"+
				"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: %s\n"+
				"–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: %d/%d\n"+
				"–ß–∞—Ç: %s (ID: %d)",
				fh.adminHandler.GetUserDisplayName(c.Sender()),
				totalCorrect,
				totalQuestions,
				c.Chat().Title,
				c.Chat().ID)
			fh.adminHandler.LogToAdmin(logMsg)
		}
		fh.state.Reset(userID)
		return nil
	}
}

// FilterMessage filters incoming messages for banned words
func (fh *FeatureHandler) FilterMessage(c tb.Context) error {
	msg := c.Message()
	if msg == nil || msg.Sender == nil {
		return nil
	}

	// Don't filter commands
	if strings.HasPrefix(msg.Text, "/") {
		return nil
	}

	// Don't filter admin messages in admin chat only
	if c.Chat().ID == fh.adminChatID {
		return nil
	}

	// Don't filter admin messages in the current chat if they are admin there
	if fh.adminHandler.IsAdmin(c.Chat(), msg.Sender) {
		return nil
	}

	log.Printf("[DEBUG] Checking message from user %d: '%s'", msg.Sender.ID, msg.Text)

	if fh.blacklist.CheckMessage(msg.Text) {
		fh.adminHandler.AddViolation(msg.Sender.ID)
		violationCount := fh.adminHandler.GetViolations(msg.Sender.ID)

		// Delete the message
		if err := fh.bot.Delete(msg); err != nil {
			log.Printf("[ERROR] Failed to delete message %d from %d: %v", msg.ID, msg.Sender.ID, err)
		} else {
			log.Printf("[DEBUG] Deleted message %d from %d (violation #%d)", msg.ID, msg.Sender.ID, violationCount)
		}

		// If it's their second violation, ban
		if violationCount >= 2 {
			if err := fh.adminHandler.BanUser(c.Chat(), msg.Sender); err != nil {
				log.Printf("[ERROR] Failed to ban user %d: %v", msg.Sender.ID, err)
			} else {
				log.Printf("[DEBUG] Banned user %d for repeated violations", msg.Sender.ID)

				fh.adminHandler.ClearViolations(msg.Sender.ID)

				// Log to admin chat
				logMsg := fmt.Sprintf("üî® –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–∞–Ω –∑–∞ –±–∞–Ω–≤–æ—Ä–¥—ã\n\n"+
					"–ó–∞–±–∞–Ω–µ–Ω: %s\n"+
					"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞—Ä—É—à–µ–Ω–∏–π: %d\n"+
					"–ß–∞—Ç: %s (ID: %d)",
					fh.adminHandler.GetUserDisplayName(msg.Sender),
					violationCount,
					c.Chat().Title,
					c.Chat().ID)
				fh.adminHandler.LogToAdmin(logMsg)
			}
		} else {
			// Warning if it's their first violation
			warningMsg, _ := fh.bot.Send(c.Chat(), fmt.Sprintf("‚ö†Ô∏è %s, —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ. –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –Ω–∞—Ä—É—à–µ–Ω–∏–∏ –±—É–¥–µ—Ç –±–∞–Ω.", fh.adminHandler.GetUserDisplayName(msg.Sender)))
			fh.adminHandler.DeleteAfter(warningMsg, 15*time.Second)

			// Log to admin chat
			logMsg := fmt.Sprintf("‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–∞—Ä—É—à–µ–Ω–∏–µ\n\n"+
				"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: %s\n"+
				"–ù–∞—Ä—É—à–µ–Ω–∏–µ: #%d\n"+
				"–°–æ–æ–±—â–µ–Ω–∏–µ: `%s`\n"+
				"–ß–∞—Ç: %s (ID: %d)",
				fh.adminHandler.GetUserDisplayName(msg.Sender),
				violationCount,
				msg.Text,
				c.Chat().Title,
				c.Chat().ID)
			fh.adminHandler.LogToAdmin(logMsg)
		}
	}
	return nil
}
